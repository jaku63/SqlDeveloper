--------------------------------------------------------
--  DDL for View VEH_PM_MAIN
--------------------------------------------------------

  CREATE OR REPLACE FORCE VIEW "VEH_PM_MAIN" ("ID", "S_HEAT_ID", "HEAT_ID", "C_HEAT_STATUS_ID", "PLANT_UNIT_NO", "START_TIME", "START_TIME_STR", "REMAINING_TIME", "END_TIME", "CE_PRACTICE_ID", "CE_PRACTICE", "NUM_OF_BASKETS", "PHASE_TYPE", "C_STEEL_GRADE_ID", "STEEL_GRADE", "C_MATERIAL_TAB_ID_TAP", "C_EQUIPMENT_ID_LADLE", "LADLE_ID", "LADLE_WEIGHT", "STEEL_WEIGHT", "SLAG_WEIGHT", "STEEL_TEMPERATURE", "START_TEMPERATURE", "POWER_ON_TIME", "T1_TIME", "ENERGY_TOTAL", "SPEC_ENERGY", "ACT_TAP_NO", "ENERGY_LOSSES", "LIQ_METAL_SI_CONTENT", "LIQ_METAL_WEIGHT", "DIS_BASKET_WEIGHT", "DRI_SUPPLIED", "DRI_REMAINING", "DRI_FEED_SPEED", "LIME_SUPPLIED", "LIME_REMAINING", "LIME_FEED_SPEED", "DOLO_SUPPLIED", "DOLO_REMAINING", "DOLO_FEED_SPEED", "SETP_LM_WEIGTH", "ROOF_POSITION", "ELECTRODE_POSITION", "TILTING_ANGLE", "SETP_MAX_LM_WEIGHT", "SETP_EL_ENERGY", "SETP_OX_AMOUNT", "SETP_C_AMOUNT", "SETP_DRI_FLOW", "SETP_LIME_FLOW", "SETP_DOLO_FLOW", "CARB_LANCE1_FLOW", "CARB_LANCE1_AMOUNT", "CARB_LANCE2_FLOW", "CARB_LANCE2_AMOUNT", "BOTTOM_TEMP0", "BOTTOM_TEMP1", "BOTTOM_TEMP2", "BOTTOM_TEMP3", "BOTTOM_TEMP4", "BOTTOM_TEMP5", "BOTTOM_TEMP6", "BOTTOM_TEMP7", "BOTTOM_TEMP8", "SCRAP_WEIGHT", "DRI_WEIGHT", "LIME_WEIGHT", "DOLO_WEIGHT", "C_CONTENT", "O_CONTENT", "OXYGEN_CONS", "MIX_GAS_CONS", "COKE_CONS", "TAP_START", "TAP_END", "TAPPING_TIME", "TAP_TEMPERATURE", "LADLE_TARE_WEIGHT", "LADLE_STEEL_NET_WEIGHT", "TAP_SLAG_WEIGHT", "SLAG_PERCENTAGE", "HOT_TAPPED", "HOT_TAP_REASON", "HOT_HEEL_WEIGHT", "VERIFIED", "VER_COMMENT", "CREATED", "MODIFIED", "MOP") AS 
  SELECT pe."ID",
    pe.S_HEAT_ID AS S_HEAT_ID,
    (SELECT HEAT_NO FROM S_HEAT WHERE ID=pe."S_HEAT_ID") AS HEAT_ID,
    pe."C_HEAT_STATUS_ID",
    (SELECT "PLANT_UNIT_NO" FROM C_PLANT_UNIT cpu WHERE cpu.ID=C_PLANT_UNIT_ID) AS "PLANT_UNIT_NO",
    pe.START_TIME,
    to_char(pe."START_TIME",'hh24:mi') as START_TIME_STR,
    round(mp."DURATION"/60) as "REMAINING_TIME",
    pe."END_TIME",
    pe."CE_PRACTICE_ID",
    (SELECT cep.PRACTICE_CODE FROM CE_PRACTICE CEP WHERE CEP.ID=pe."CE_PRACTICE_ID") AS "CE_PRACTICE",
    pe."NUM_OF_BASKETS",
    (SELECT PHASE_TYPE FROM C_PHASE WHERE "ID" = mh.CURR_PHASE_TYPE_ID) as "PHASE_TYPE",
    pe.C_STEEL_GRADE_ID,
    (SELECT STEEL_GRADE FROM C_STEEL_GRADE CS WHERE CS.ID=pe."C_STEEL_GRADE_ID") AS "STEEL_GRADE",
    (SELECT C_MATERIAL_TAB_ID FROM C_STEEL_GRADE CS WHERE CS.ID=pe."C_STEEL_GRADE_ID") AS "C_MATERIAL_TAB_ID_TAP",
    pe."C_EQUIPMENT_ID_LADLE",
    (SELECT EQUIPMENT_NAME FROM C_EQUIPMENT CE WHERE CE.ID=pe."C_EQUIPMENT_ID_LADLE" ) AS LADLE_ID,
    pe."LADLE_WEIGHT",
    mh.STEEL_WEIGHT AS "STEEL_WEIGHT",
    mh.SLAG_WEIGHT AS "SLAG_WEIGHT",
    mh.CALCUL_TEMPERATURE AS "STEEL_TEMPERATURE",
    pe."START_TEMPERATURE",
    pe."POWER_ON_TIME",
    pe."T1_TIME",
    pe."ENERGY_TOTAL",
    mh.SPECIFIC_ENERGY AS "SPEC_ENERGY",
    pe.ACT_TAP_NO AS "ACT_TAP_NO",
    mh.ENERGY_LOSS_SUMM  AS "ENERGY_LOSSES",
    (SELECT ELE_AMOUNT*100 FROM C_MATERIAL_ANA cma WHERE cma.ele_symbol_id=(select id from c_element where ele_symbol='Si')
      and cma.c_material_id=(select id from c_material where mat_code='LQIN0010')) AS LIQ_METAL_SI_CONTENT,
    (SELECT SUM(FINAL_WEIGHT) FROM PE_HOT_METAL phm WHERE phm.S_HEAT_ID= pe.S_HEAT_ID) AS LIQ_METAL_WEIGHT,
    (SELECT SUM(MAT_WEIGHT) FROM PE_BASKET_DET pbd WHERE pbd.PE_BASKET_ID IN (SELECT ID FROM PE_BASKET PEB WHERE PEB.S_HEAT_ID= pe.S_HEAT_ID)) AS DIS_BASKET_WEIGHT,
    pe.DRI_WEIGHT AS DRI_SUPPLIED,
    (case when (mp.DRI_WEIGHT - pe.DRI_WEIGHT) > 0 then (mp.DRI_WEIGHT - pe.DRI_WEIGHT) else 0 end) AS DRI_REMAINING,
    pe.DRI_FEED_RATE AS DRI_FEED_SPEED,
    pe.LIME_WEIGHT AS LIME_SUPPLIED,
    (case when (mp.LIME_WEIGHT - pe.LIME_WEIGHT) > 0 then (mp.LIME_WEIGHT - pe.LIME_WEIGHT) else 0 end) AS LIME_REMAINING,
    round(pe.LIME_FEED_RATE) AS LIME_FEED_SPEED,
    pe.DOLO_WEIGHT AS DOLO_SUPPLIED,
    (case when (mp.DOLOMITE_WEIGHT - pe.DOLO_WEIGHT) > 0 then (mp.DOLOMITE_WEIGHT - pe.DOLO_WEIGHT) else 0 end) AS DOLO_REMAINING,
    round(pe.DOLO_FEED_RATE) AS DOLO_FEED_SPEED,
    0 AS SETP_LM_WEIGTH,
    pe.ROOF_POSITION AS ROOF_POSITION,
    pe.ELECTRODE_POSITION AS ELECTRODE_POSITION,
    pe.TILTING_ANGLE AS TILTING_ANGLE,
    mp.MAX_HM_WEIGHT AS SETP_MAX_LM_WEIGHT,
    round(mp.EL_ENERGY_DEMAND) AS SETP_EL_ENERGY,
    round(mp.O2_DEMAND) AS SETP_OX_AMOUNT,
    0 AS SETP_C_AMOUNT,
    mp.DRI_FEED_RATE AS SETP_DRI_FLOW,
    mp.LIME_FEED_RATE AS SETP_LIME_FLOW,
    mp.DOLOMITE_FEED_RATE AS SETP_DOLO_FLOW,
    (SELECT MAT_FLOW FROM PE_BLOW_REPORT PEB WHERE PEB.S_HEAT_ID=pe.S_HEAT_ID and PEB.c_equip_id=(SELECT ID FROM C_EQUIPMENT WHERE EQUIPMENT_NAME = 'CARBON_LANCE1' )) AS CARB_LANCE1_FLOW,
    (SELECT MAT_AMOUNT FROM PE_BLOW_REPORT PEB WHERE PEB.S_HEAT_ID=pe.S_HEAT_ID and PEB.c_equip_id=(SELECT ID FROM C_EQUIPMENT WHERE EQUIPMENT_NAME = 'CARBON_LANCE1' )) AS CARB_LANCE1_AMOUNT,
    (SELECT MAT_FLOW FROM PE_BLOW_REPORT PEB WHERE PEB.S_HEAT_ID=pe.S_HEAT_ID and PEB.c_equip_id=(SELECT ID FROM C_EQUIPMENT WHERE EQUIPMENT_NAME = 'CARBON_LANCE2' )) AS CARB_LANCE2_FLOW,
    (SELECT MAT_AMOUNT FROM PE_BLOW_REPORT PEB WHERE PEB.S_HEAT_ID=pe.S_HEAT_ID and PEB.c_equip_id=(SELECT ID FROM C_EQUIPMENT WHERE EQUIPMENT_NAME = 'CARBON_LANCE2' )) AS CARB_LANCE2_AMOUNT,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=0) AS BOTTOM_TEMP0,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=1) AS BOTTOM_TEMP1,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=2) AS BOTTOM_TEMP2,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=3) AS BOTTOM_TEMP3,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=4) AS BOTTOM_TEMP4,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=5) AS BOTTOM_TEMP5,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=6) AS BOTTOM_TEMP6,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=7) AS BOTTOM_TEMP7,
    (SELECT MEAS_TEMP FROM PE_BOTTOM_TEMP_REPORT bt WHERE bt.C_PLANT_UNIT_ID=pe.C_PLANT_UNIT_ID AND bt.S_HEAT_ID=pe.S_HEAT_ID AND TEMP_ID=8) AS BOTTOM_TEMP8,
    pe."SCRAP_WEIGHT",
    pe."DRI_WEIGHT",
    pe."LIME_WEIGHT",
    pe."DOLO_WEIGHT",
    pe."C_CONTENT",
    pe."O_CONTENT",
    pe."OXYGEN_CONS",
    pe."MIX_GAS_CONS",
    pe."COKE_CONS",
    pe."TAP_START",
    pe."TAP_END",
    pe."TAPPING_TIME",
    pe."TAP_TEMPERATURE",
    pe."LADLE_TARE_WEIGHT",
    pe."LADLE_STEEL_NET_WEIGHT",
    pe."TAP_SLAG_WEIGHT",
    pe."SLAG_PERCENTAGE",
    pe."HOT_TAPPED",
    pe."HOT_TAP_REASON",
    pe."HOT_HEEL_WEIGHT",
    pe."VERIFIED",
    pe."VER_COMMENT",
    pe."CREATED",
    pe."MODIFIED",
    pe."MOP"
  FROM PE_HEAT pe, ME_HEAT mh, ME_PREDICTION mp WHERE
    C_HEAT_STATUS_ID=GET_HEAT_STATUS_ID(20)
    and mh.s_heat_id = pe.S_HEAT_ID
    and mp.s_heat_id = pe.s_heat_id;
